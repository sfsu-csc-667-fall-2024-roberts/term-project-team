<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monopoly Online</title>
    <link rel="stylesheet" href="/dist/styles.css">
</head>
<body>
  <div class="game-container">
    <!-- Main Header -->
    <header class="game-header">
      <div class="header-left">
        <h1 class="game-title">Monopoly Online</h1>
        <span class="game-id">Game #<%= game.id %></span>
        <button class="header-action-button view-rules-button" id="view-rules">View Rules</button>
      </div>
      
      <div class="header-center">
        <div class="game-status-wrapper">
          <div class="game-status" title="Click to view game history">
            <% if (gameState.phase === 'waiting') { %>
              Initial Roll Phase - Roll to determine turn order (<%= gameState.dice_rolls.length %>/<%= players.length %> players rolled)
            <% } else if (gameState.phase === 'playing') { %>
              <% const currentPlayer = players.find(p => p.id === gameState.turnOrder[gameState.currentPlayerIndex]); %>
              <%= currentPlayer ? `${currentPlayer.username}'s Turn` : 'Loading...' %>
              <% if (currentPlayer && currentPlayer.id === currentPlayerId) { %>
                - Your turn!
              <% } %>
            <% } else { %>
              <%= game.status %>
            <% } %>
          </div>
        </div>
      </div>
      
      <div class="header-right">
        <button class="header-action-button danger end-game-button" id="end-game">End Game</button>
        <div class="user-info">
          Welcome, <%= username %>
          <a href="/logout" class="logout-link">Logout</a>
        </div>
      </div>
    </header>

    <!-- Main Game Content -->
    <main class="game-content">
      <!-- Players Section -->
      <section class="players-section">
        <header class="panel-header">
          <h2 class="panel-title">Players</h2>
        </header>
        <div class="panel-content">
          <div class="players-list">
            <% const sortedPlayers = players.sort((a, b) => { %>
            <%   if (a.isBot === b.isBot) return 0; %>
            <%   return a.isBot ? 1 : -1; %>
            <% }); %>
            
            <% sortedPlayers.forEach((player) => { %>
              <div class="player-card <%= player.id === currentPlayerId ? 'current-player' : '' %>"
                   data-player-id="<%= player.id %>">
                <div class="player-avatar">
                  <%= player.isBot ? 'ðŸ¤–' : 'ðŸ‘¤' %>
                </div>
                <div class="player-info">
                  <div class="player-name">
                    <%= player.username %>
                    <% if (player.id === currentPlayerId) { %>
                      <span class="player-you">(You)</span>
                    <% } %>
                  </div>
                  <div class="player-stats">
                    <div class="player-balance">$<%= player.balance %></div>
                    <div class="player-position">
                      <% if (gameState.phase === 'playing') { %>
                        <%= player.position %>
                      <% } %>
                    </div>
                    <div class="roll-status">
                      <% if (gameState.phase === 'waiting') { %>
                        <% const playerRoll = gameState.dice_rolls.find(r => r.id === player.id); %>
                        <%= playerRoll ? `Rolled: ${playerRoll.roll}` : 'Waiting for roll...' %>
                      <% } else { %>
                        <% if (gameState.turnOrder[gameState.currentPlayerIndex] === player.id) { %>
                          Current turn
                        <% } else { %>
                          Waiting...
                        <% } %>
                      <% } %>
                    </div>
                  </div>
                  <% if (player.id === currentPlayerId) { %>
                    <div class="player-controls">
                      <button id="roll-dice" class="btn btn-primary"
                        <%= (gameState.phase === 'waiting' && !gameState.dice_rolls.find(r => r.id === currentPlayerId)) ||
                            (gameState.phase === 'playing' && gameState.turnOrder[gameState.currentPlayerIndex] === currentPlayerId)
                            ? '' : 'disabled' %>>
                        Roll
                      </button>
                      <button id="end-turn" class="btn btn-secondary" 
                        <%= gameState.phase === 'playing' && gameState.turnOrder[gameState.currentPlayerIndex] === currentPlayerId
                            ? '' : 'disabled' %>>
                        End Turn
                      </button>
                    </div>
                  <% } %>
                </div>
              </div>
            <% }); %>
          </div>
        </div>
      </section>

      <!-- Game Board -->
      <section class="game-board-wrapper">
        <div class="game-board">
          <div id="monopoly-board"></div>
        </div>
      </section>

      <!-- Properties Section -->
      <section class="properties-section">
        <header class="panel-header">
          <h2 class="panel-title">Properties</h2>
        </header>
        <div class="panel-content">
          <div class="tab-buttons">
            <button class="tab-button active" data-tab="available">Available</button>
            <button class="tab-button" data-tab="yours">Your Properties</button>
            <button class="tab-button" data-tab="owned">Other Players</button>
          </div>
          <div class="tab-content">
            <div class="tab-pane active" id="available">
              <div class="properties-list">
                <% const availableProps = properties.filter(p => !p.ownerId); %>
                <% const groupedProperties = availableProps.reduce((acc, prop) => {
                  if (prop.colorGroup) {
                    if (!acc[prop.colorGroup]) {
                      acc[prop.colorGroup] = [];
                    }
                    acc[prop.colorGroup].push(prop);
                  }
                  return acc;
                }, {}); %>

                <% Object.entries(groupedProperties).forEach(([colorGroup, props]) => { %>
                  <div class="property-group" data-color-group="<%= colorGroup %>">
                    <h3 class="group-title"><%= colorGroup.charAt(0).toUpperCase() + colorGroup.slice(1) %></h3>
                    <div class="group-properties">
                      <% props.forEach((property) => { %>
                        <div class="property-card" data-property-id="<%= property.id %>">
                          <div class="color-strip" style="background-color: <%= property.colorGroup %>"></div>
                          <div class="property-name"><%= property.name %></div>
                          <div class="property-price">$<%= property.price %></div>
                          <div class="property-rent">Rent: $<%= property.rent_levels[0] %></div>
                        </div>
                      <% }); %>
                    </div>
                  </div>
                <% }); %>

                <!-- Special Properties (Railroads and Utilities) -->
                <div class="special-properties">
                  <h3>Railroads & Utilities</h3>
                  <div class="group-properties">
                    <% properties.filter(p => !p.colorGroup && !p.ownerId).forEach((property) => { %>
                      <div class="property-card <%= property.type %>" data-property-id="<%= property.id %>">
                        <div class="property-name"><%= property.name %></div>
                        <div class="property-price">$<%= property.price %></div>
                        <div class="property-rent">Rent: $<%= property.rent_levels[0] %></div>
                      </div>
                    <% }); %>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane" id="yours">
              <div class="properties-list">
                <% const yourProps = properties.filter(p => p.ownerId === currentPlayerId); %>
                <% const groupedYourProps = yourProps.reduce((acc, prop) => {
                  if (prop.colorGroup) {
                    if (!acc[prop.colorGroup]) {
                      acc[prop.colorGroup] = [];
                    }
                    acc[prop.colorGroup].push(prop);
                  }
                  return acc;
                }, {}); %>

                <% Object.entries(groupedYourProps).forEach(([colorGroup, props]) => { %>
                  <div class="property-group" data-color-group="<%= colorGroup %>">
                    <h3 class="group-title"><%= colorGroup.charAt(0).toUpperCase() + colorGroup.slice(1) %></h3>
                    <div class="group-properties">
                      <% props.forEach((property) => { %>
                        <div class="property-card" data-property-id="<%= property.id %>">
                          <div class="color-strip" style="background-color: <%= property.colorGroup %>"></div>
                          <div class="property-name"><%= property.name %></div>
                          <div class="property-price">$<%= property.price %></div>
                          <div class="property-rent">Current Rent: $<%= property.rent_levels[property.houseCount] %></div>
                          <div class="property-stats">
                            <% if (property.houseCount > 0) { %>
                              <div class="house-count">Houses: <%= property.houseCount %></div>
                            <% } %>
                            <% if (property.hasHotel) { %>
                              <div class="hotel-indicator">Hotel</div>
                            <% } %>
                            <% if (property.isMortgaged) { %>
                              <div class="mortgaged-indicator">Mortgaged</div>
                            <% } %>
                          </div>
                          <div class="property-actions">
                            <button class="btn btn-small" onclick="handleBuildHouse(<%= property.id %>)">Build</button>
                            <button class="btn btn-small" onclick="handleMortgage(<%= property.id %>)">
                              <%= property.isMortgaged ? 'Unmortgage' : 'Mortgage' %>
                            </button>
                          </div>
                        </div>
                      <% }); %>
                    </div>
                  </div>
                <% }); %>

                <!-- Your Special Properties -->
                <div class="special-properties">
                  <h3>Your Railroads & Utilities</h3>
                  <div class="group-properties">
                    <% properties.filter(p => !p.colorGroup && p.ownerId === currentPlayerId).forEach((property) => { %>
                      <div class="property-card <%= property.type %>" data-property-id="<%= property.id %>">
                        <div class="property-name"><%= property.name %></div>
                        <div class="property-price">$<%= property.price %></div>
                        <div class="property-rent">Current Rent: $<%= property.rent_levels[0] %></div>
                        <% if (property.isMortgaged) { %>
                          <div class="mortgaged-indicator">Mortgaged</div>
                        <% } %>
                        <div class="property-actions">
                          <button class="btn btn-small" onclick="handleMortgage(<%= property.id %>)">
                            <%= property.isMortgaged ? 'Unmortgage' : 'Mortgage' %>
                          </button>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane" id="owned">
              <div class="properties-list">
                <% const otherProps = properties.filter(p => p.ownerId && p.ownerId !== currentPlayerId); %>
                <% const groupedOtherProps = otherProps.reduce((acc, prop) => {
                  const owner = players.find(p => p.id === prop.ownerId);
                  const ownerName = owner ? owner.username : 'Unknown';
                  if (!acc[ownerName]) {
                    acc[ownerName] = [];
                  }
                  acc[ownerName].push(prop);
                  return acc;
                }, {}); %>

                <% Object.entries(groupedOtherProps).forEach(([ownerName, props]) => { %>
                  <div class="owner-group">
                    <h3 class="owner-title"><%= ownerName %>'s Properties</h3>
                    <div class="group-properties">
                      <% props.forEach((property) => { %>
                        <div class="property-card" data-property-id="<%= property.id %>">
                          <% if (property.colorGroup) { %>
                            <div class="color-strip" style="background-color: <%= property.colorGroup %>"></div>
                          <% } %>
                          <div class="property-name"><%= property.name %></div>
                          <div class="property-price">$<%= property.price %></div>
                          <div class="property-rent">Current Rent: $<%= property.rent_levels[property.houseCount] %></div>
                          <div class="property-stats">
                            <% if (property.houseCount > 0) { %>
                              <div class="house-count">Houses: <%= property.houseCount %></div>
                            <% } %>
                            <% if (property.hasHotel) { %>
                              <div class="hotel-indicator">Hotel</div>
                            <% } %>
                            <% if (property.isMortgaged) { %>
                              <div class="mortgaged-indicator">Mortgaged</div>
                            <% } %>
                          </div>
                        </div>
                      <% }); %>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Game Messages -->
    <div class="game-messages" aria-live="polite"></div>
    
    <!-- Message History -->
    <div class="message-history" id="message-history">
      <header class="message-history-header">
        <h3 class="message-history-title">Game History</h3>
        <button class="close-history" aria-label="Close history">&times;</button>
      </header>
      <div class="message-history-content"></div>
    </div>
  </div>

  <script>
    window.gameData = <%- JSON.stringify({
      gameId: game.id,
      players,
      currentUserId,
      currentPlayerId,
      properties,
      gameState
    }, null, 2) %>;
  </script>

  <script src="/dist/game.bundle.js"></script>

  <%- include('partials/footer') %>
</body>
</html> 